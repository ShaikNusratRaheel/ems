<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Events - EventManager</title>
    <link rel="stylesheet" href="userhome.css">
    <link rel="stylesheet" href="user-pages.css">
    <style>
        .loading-ring {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* .dashboard {
    display: flex;
    min-height: 100vh;
} */

/* .main-content {
    flex: 1;
    padding: 1.5rem;
    background: #f8f9fa;
} */

.event-card {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease-in-out;
    padding: 0.8rem;
    gap: 1rem;
}

.event-card:hover {
    transform: translateY(-3px);
}



.event-content {
    flex: 1;
}

.event-date, .event-time {
    display: inline-block;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
}

.event-date {
    background: #e3f2fd;
    color: #1976d2;
}

.event-time {
    background: #fff3e0;
    color: #f57c00;
    margin-left: 0.4rem;
}

.event-status {
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    text-transform: uppercase;
}

.upcoming {
    background: #fff3e0;
    color: #f57c00;
}

.completed {
    background: #e8f5e9;
    color: #2e7d32;
}

.cancelled {
    background: #ffebee;
    color: #c62828;
}

.event-title {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin: 0.5rem 0;
}

.event-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.9rem;
}

    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>EventManager</h1>
                <p>User Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="userhome.html" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            Home
                        </a>
                    </li>
                    <li>
                        <a href="registerevent.html" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Register for Events
                        </a>
                    </li>
                    <li>
                        <a href="viewregisteredevents.html" class="nav-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                            My Registered Events
                        </a>
                    </li>
                    <li>
                        <a href="reminders.html" class="nav-link active">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                            Reminders & Notifications
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a onclick="logout" href="https://us-east-18ayp9fozb.auth.us-east-1.amazoncognito.com/logout?client_id=4u8498hkb3nljv9c343g9ktgk2&redirect_uri=https://master.d1p222prhjubuw.amplifyapp.com/callback.html&response_type=token&scope=aws.cognito.signin.user.admin+email+openid+phone+profile" class="logout-btn" id="logoutBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    Logout
                </a>
            </div>
        </aside>

        <main class="main-content">
            <h2>This Week's Events</h2>
            <div class="loading-ring" id="loading"></div>
            <div class="event-list" id="eventList">
                <!-- Events will be populated here -->
            </div>
        </main>
    </div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.834.0.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="user-pages.js"></script>
    <script>
        const getImage = (event) => {
            return `https://eventimages09.s3.us-east-1.amazonaws.com/${event}`;
        };

        function getUserIdFromToken() {
            try {
                const token = localStorage.getItem("id_token");
                if (!token) {
                    console.warn("No authentication token found");
                    return null;
                }
                const payload = JSON.parse(atob(token.split(".")[1]));
                return payload.sub || null;
            } catch (error) {
                console.error("Error parsing authentication token:", error);
                return null;
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const userId = getUserIdFromToken();
            if (!userId) {
                document.getElementById("eventList").innerHTML = 
                    "<div class='no-events'>Failed to load events: User not authenticated.</div>";
                return;
            }

            document.getElementById("loading").style.display = "block";
            const eventList = document.getElementById("eventList");
            

            fetch(`https://3q516gt0rb.execute-api.us-east-1.amazonaws.com/stage4/user/reminders?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = "none";
                    let events;
                    try {
                        events = JSON.parse(data.body);
                    } catch (error) {
                        throw new Error("Failed to parse events data");
                    }
                    finally {
            document.getElementById("loading").style.display = "none"; // Hide loading ring
        }

                    if (!Array.isArray(events) || events.length === 0) {
                        eventList.innerHTML = "<div class='no-events'>No events scheduled for this week</div>";
                        return;
                    }

                    const groupedByDay = {};
                    events.forEach(event => {
                        if (!groupedByDay[event.date]) {
                            groupedByDay[event.date] = [];
                        }
                        groupedByDay[event.date].push(event);
                    });

                    eventList.innerHTML = Object.entries(groupedByDay)
                        .map(([date, dayEvents]) => `
                            <div class="day-section">
                                <div class="event-list-container">
                                    ${dayEvents.map(event => `
                                        <div class="event-card">
                                            <img src="${getImage(event.s3_key)}" alt="${event.title}" class="event-thumbnail">
                                            <div class="event-content">
                                                <span class="event-date">${event.date}</span>
                                                <span class="event-time">${event.time}</span>
                                                <h4 class="event-title">${event.title}</h4>
                                                <div class="event-meta">
                                                    <span>üìç ${event.location || 'Location TBA'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                })
                .catch(error => {
                    loading.style.display = "none";
                    console.error("Error fetching events:", error);
                    eventList.innerHTML = 
                        "<div class='no-events'>Failed to load events. Please try again later.</div>";
                });
                
        });

        function logout() {
    localStorage.removeItem("access_token");
    localStorage.removeItem("id_token");
    window.location.href = "https://master.d1p222prhjubuw.amplifyapp.com/";
}
    </script>
</body>
</html>